#!/usr/bin/env python3
# test_camera_opencv.py

import cv2
import time
import sys

def test_camera_opencv(device_id=0):
    """
    使用OpenCV测试摄像头
    device_id: 摄像头设备ID，对于/dev/video0是0，对于/dev/video1是1，依此类推
    """
    print(f"尝试打开摄像头设备 /dev/video{device_id}...")
    
    # 方法1：使用设备ID
    cap = cv2.VideoCapture(device_id)
    
    # 方法2：使用设备路径（在某些情况下更可靠）
    # cap = cv2.VideoCapture(f'/dev/video{device_id}')
    
    if not cap.isOpened():
        print(f"错误：无法打开摄像头 /dev/video{device_id}")
        print("可能的原因：")
        print("1. 摄像头未连接或连接不良")
        print("2. 设备权限不足，尝试：sudo chmod 666 /dev/video*")
        print("3. 摄像头驱动问题")
        print("4. 设备ID错误，尝试其他ID（0, 1, 2...）")
        return False
    
    print(f"成功打开摄像头！")
    print(f"摄像头信息：")
    
    # 获取摄像头属性
    width = cap.get(cv2.CAP_PROP_FRAME_WIDTH)
    height = cap.get(cv2.CAP_PROP_FRAME_HEIGHT)
    fps = cap.get(cv2.CAP_PROP_FPS)
    
    print(f"  分辨率: {width} x {height}")
    print(f"  FPS: {fps}")
    
    # 尝试读取几帧
    print("尝试读取图像帧...")
    success_count = 0
    
    for i in range(30):  # 尝试30次
        ret, frame = cap.read()
        
        if ret:
            success_count += 1
            if i == 0:  # 第一帧成功时显示信息
                print(f"  第{i+1}帧读取成功，图像shape: {frame.shape}")
        else:
            print(f"  第{i+1}帧读取失败")
        
        time.sleep(0.1)  # 稍微等待一下
    
    success_rate = success_count / 30 * 100
    print(f"读取成功率: {success_rate:.1f}% ({success_count}/30)")
    
    if success_rate > 0:
        print("\n显示图像（按任意键退出）...")
        # 显示最后一帧成功的图像
        if success_count > 0:
            cv2.imshow(f"Camera /dev/video{device_id}", frame)
            cv2.waitKey(0)
            cv2.destroyAllWindows()
    
    # 释放摄像头
    cap.release()
    print("摄像头已释放")
    
    return success_rate > 0

def list_video_devices():
    """列出所有可用的视频设备"""
    print("检测系统中的视频设备...")
    import os
    import glob
    
    video_devices = glob.glob('/dev/video*')
    
    if not video_devices:
        print("未找到任何 /dev/video* 设备")
        return []
    
    print(f"找到 {len(video_devices)} 个视频设备:")
    for device in sorted(video_devices):
        # 检查设备权限
        try:
            mode = os.stat(device).st_mode
            readable = os.access(device, os.R_OK)
            writable = os.access(device, os.W_OK)
            perm_str = "r" if readable else "-"
            perm_str += "w" if writable else "-"
            
            print(f"  {device}: 权限 [{perm_str}]")
        except:
            print(f"  {device}: 无法访问")
    
    return video_devices

def test_all_cameras():
    """测试所有可能的摄像头设备"""
    print("=== 开始摄像头测试 ===\n")
    
    # 先列出所有设备
    devices = list_video_devices()
    
    if not devices:
        print("未找到任何视频设备，测试结束")
        return
    
    print("\n=== 开始逐个测试摄像头 ===\n")
    
    results = {}
    max_device_id = 10  # 最多测试到/dev/video10
    
    for device_id in range(max_device_id + 1):
        print(f"\n--- 测试 /dev/video{device_id} ---")
        try:
            success = test_camera_opencv(device_id)
            results[device_id] = success
        except Exception as e:
            print(f"测试过程中发生异常: {e}")
            results[device_id] = False
        
        time.sleep(0.5)  # 测试间隔
    
    print("\n=== 测试结果汇总 ===")
    for device_id, success in results.items():
        status = "✓ 正常" if success else "✗ 无法打开"
        print(f"/dev/video{device_id}: {status}")

if __name__ == "__main__":
    # 如果提供了命令行参数，测试指定设备
    if len(sys.argv) > 1:
        try:
            device_id = int(sys.argv[1])
            test_camera_opencv(device_id)
        except ValueError:
            print("请提供有效的设备ID（数字）")
    else:
        # 否则测试所有设备
        test_all_cameras()